<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hill Climb Racer - Jetpack & Stunts (Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* Basic styles for the page */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #000;
        }

        /* Dynamic sky background */
        #sky-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            transition: background 2s linear;
        }

        /* Game and UI container */
        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.1s ease-out;
        }

        /* Styles for the game canvas */
        canvas {
            display: block;
            background: transparent;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        /* Parallax background styles */
        .parallax-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%; /* Wider for scrolling */
            height: 100%;
            background-repeat: repeat-x;
            background-position: bottom left;
            transition: opacity 2s ease-in-out;
            opacity: 0;
        }
        
        #mountains, #desert-bg, #moon-bg {
            background-size: 50% 60%;
            z-index: 1;
        }
        #mountains {
             background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 400"><path fill="%235c6474" opacity="0.6" d="M0 400 L0 300 L50 250 L150 320 L250 200 L350 300 L450 150 L550 280 L650 180 L750 290 L850 220 L950 310 L1050 240 L1150 350 L1200 300 L1200 400 Z" /><path fill="%23454b57" opacity="0.3" d="M0 400 L0 320 L80 280 L180 340 L280 250 L380 320 L480 200 L580 300 L680 220 L780 310 L880 260 L980 330 L1080 280 L1180 370 L1200 320 L1200 400 Z" /></svg>');
        }
         #desert-bg {
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 400"><path fill="%23D2B48C" opacity="0.7" d="M0 400 L0 320 L100 280 L200 350 L300 250 L400 330 L500 200 L600 310 L700 240 L800 320 L900 260 L1000 340 L1100 290 L1200 360 L1200 400 Z"/><path fill="%23C19A6B" opacity="0.4" d="M0 400 L0 340 L150 300 L250 360 L350 280 L450 340 L550 260 L650 320 L750 270 L850 330 L950 280 L1050 350 L1150 310 L1200 370 L1200 400 Z"/></svg>');
        }
         #moon-bg {
             background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 400"><circle cx="100" cy="350" r="50" fill="%23555"/><circle cx="500" cy="380" r="80" fill="%23444"/><circle cx="700" cy="320" r="60" fill="%23666"/></svg>');
             background-size: 30% 30%;
         }

        #clouds-far, #stars-far {
            background-size: 40%;
            z-index: 2;
        }
        #clouds-far {
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 200"><path fill="rgba(255,255,255,0.4)" d="M100 100 Q150 50 200 100 T300 100 M400 120 Q450 70 500 120 T600 120 M650 90 Q700 40 750 90 T850 90" /></svg>');
        }
        
        #stars-far {
             background-image: radial-gradient(1px 1px at 20px 30px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 40px 80px, white, rgba(255,255,255,0)), radial-gradient(1px 1px at 150px 120px, white, rgba(255,255,255,0)), radial-gradient(2px 2px at 250px 50px, white, rgba(255,255,255,0));
             background-size: 200px 200px;
        }
        
        #hills_fg {
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 300"><path fill="%232E4627" d="M -10,300 C 100,100 250,150 400,200 S 600,250 800,150 S 1010,200 1010,200 V 300 Z" /></svg>');
            background-size: 60% 40%;
            z-index: 11;
        }

        /* Overlay for UI elements */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none; /* Hidden by default */
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
        }
        
        /* Stunt message text */
        #stunt-text {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3em;
            font-weight: bold;
            color: #f1c40f;
            text-shadow: 3px 3px 0 #c0392b, -1px -1px 0 #c0392b, 1px -1px 0 #c0392b, -1px 1px 0 #c0392b, 1px 1px 0 #c0392b;
            opacity: 0;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            pointer-events: none;
            z-index: 1000;
        }
        
        #stunt-text.show {
            opacity: 1;
            transform: translateX(-50%) scale(1.1);
        }

        /* Top UI container */
        .top-ui {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .info-box {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            border: 2px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
        }
        
        #coin-counter::before {
             content: 'ðŸ’°';
             margin-right: 10px;
        }

        .fuel-container, .jetpack-container {
            width: 200px;
            height: 30px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        #fuel-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #f9d423, #ff4e50);
            border-radius: 12px 0 0 12px;
            transition: width 0.2s ease-in-out;
        }

        #jetpack-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #00d2ff, #3a7bd5);
            border-radius: 12px 0 0 12px;
            transition: width 0.2s ease-in-out;
        }
        
        /* Bottom controls */
        .controls-ui {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
            pointer-events: auto;
        }

        .control-button {
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            font-size: 3em;
            color: white;
            cursor: pointer;
            user-select: none;
            text-shadow: 0 0 10px black;
            transition: all 0.1s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .control-button:active {
            transform: scale(0.9);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .button-cluster {
            display: flex;
            gap: 20px;
        }
        
        /* Modal screens */
        .modal-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100;
            pointer-events: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal-screen.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-screen h1 {
            font-size: 3em;
            margin: 0;
            text-shadow: 0 0 20px #ff00de;
        }

        .modal-screen h2 {
            font-size: 1.5em;
            margin: 20px 0 10px 0;
            width: 100%;
            text-align: center;
        }

        .modal-button {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 5px 10px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
            margin: 10px;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.5);
        }
        
        .modal-button-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .modal-close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2em;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }

        .selection-container {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .selection-option {
            background: rgba(255,255,255,0.1);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 180px;
            box-sizing: border-box;
        }

        .selection-option:hover, .selection-option.selected {
            background: rgba(255,255,255,0.3);
            border-color: #ff00de;
            transform: scale(1.05);
        }

        .selection-option h3 { margin: 0 0 10px 0; font-size: 1.2em; }
        .selection-option p { font-size: 0.9em; margin: 0; }
        .car-preview { width: 100%; height: 70px; margin-bottom: 10px; }
        .map-preview { width: 100%; height: 80px; border-radius: 10px; background-size: cover; background-position: center; }

        /* Upgrade screen styles */
        #upgrade-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            width: 90%;
            max-width: 600px;
        }
        .upgrade-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .upgrade-item h3 { margin: 0 0 10px; }
        .level-bar {
            background: #555;
            border-radius: 5px;
            overflow: hidden;
            height: 10px;
            margin: 5px 0;
        }
        .level-bar-inner {
            background: #4CAF50;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        .upgrade-button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #f1c40f;
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 5px;
        }
        .upgrade-button.maxed {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

    </style>
</head>
<body>
    <div id="sky-gradient"></div>
    <div id="game-wrapper">
        <div id="mountains" class="parallax-bg"></div>
        <div id="desert-bg" class="parallax-bg"></div>
        <div id="moon-bg" class="parallax-bg"></div>
        <div id="clouds-far" class="parallax-bg"></div>
        <div id="stars-far" class="parallax-bg"></div>

        <div id="game-container"></div>
        <div id="stunt-text"></div>
        <div id="hills_fg" class="parallax-bg"></div>

        <div id="ui-overlay" class="ui-overlay">
            <div class="top-ui">
                <div class="info-box-cluster" style="display:flex; flex-direction:column; gap: 10px;">
                    <div id="score" class="info-box">Score: 0</div>
                    <div id="coin-counter" class="info-box coins">0</div>
                </div>
                <div class="info-box-cluster" style="display:flex; flex-direction:column; align-items:flex-end; gap: 10px;">
                    <div class="fuel-container">
                        <div id="fuel-bar"></div>
                    </div>
                    <div class="jetpack-container">
                        <div id="jetpack-bar"></div>
                    </div>
                </div>
            </div>
            <div class="controls-ui">
                <div class="button-cluster">
                    <button id="brake-button" class="control-button">â¤º</button>
                    <button id="gas-button" class="control-button">â¤¼</button>
                </div>
            </div>
        </div>
        
        <div id="start-screen" class="modal-screen active">
            <h1>Hill Racer</h1>
            
            <h2>Select Vehicle</h2>
            <div id="car-selection" class="selection-container">
                <!-- Car options populated by JS -->
            </div>
            
            <h2>Select Map</h2>
            <div id="map-selection" class="selection-container">
                <!-- Map options populated by JS -->
            </div>

            <div class="modal-button-group">
                <button id="main-upgrades-button" class="modal-button">Upgrades</button>
                <button id="start-button" class="modal-button">Start Driving</button>
            </div>
            <p style="font-size: 1.2em; margin-top: 20px;">Total Coins: <span id="total-coins-start">0</span> ðŸ’°</p>
            <p style="margin-top:20px; font-size:1.1em; color: #ccc;">Controls: Arrow Keys & Spacebar (for Jetpack)</p>
        </div>

        <div id="game-over-screen" class="modal-screen">
            <h1>Game Over</h1>
            <p id="final-score"></p>
            <p id="final-coins"></p>
            <div class="modal-button-group">
                <button id="restart-button" class="modal-button">Play Again</button>
                <button id="upgrades-button" class="modal-button">Upgrades</button>
            </div>
        </div>

        <div id="upgrade-screen" class="modal-screen">
            <button id="upgrade-close-button" class="modal-close-button">âœ–</button>
            <h1>Upgrades</h1>
            <p>Total Coins: <span id="total-coins-upgrade">0</span> ðŸ’°</p>
            <div id="upgrade-list"></div>
        </div>
    </div>

    <script>
        (function() {
            const { Engine, Render, Runner, World, Bodies, Body, Composite, Constraint, Events, Vector, Query } = Matter;

            // --- DOM Elements ---
            const gameWrapper = document.getElementById('game-wrapper');
            const gameContainer = document.getElementById('game-container');
            const uiOverlay = document.getElementById('ui-overlay');
            const scoreElement = document.getElementById('score');
            const coinElement = document.getElementById('coin-counter');
            const fuelBarElement = document.getElementById('fuel-bar');
            const jetpackBarElement = document.getElementById('jetpack-bar');
            const startScreen = document.getElementById('start-screen');
            const gameOverScreen = document.getElementById('game-over-screen');
            const upgradeScreen = document.getElementById('upgrade-screen');
            const finalScoreElement = document.getElementById('final-score');
            const finalCoinsElement = document.getElementById('final-coins');
            const restartButton = document.getElementById('restart-button');
            const startButton = document.getElementById('start-button');
            const upgradesButton = document.getElementById('upgrades-button');
            const mainUpgradesButton = document.getElementById('main-upgrades-button');
            const upgradeCloseButton = document.getElementById('upgrade-close-button');
            const gasButton = document.getElementById('gas-button');
            const brakeButton = document.getElementById('brake-button');
            const carSelectionContainer = document.getElementById('car-selection');
            const mapSelectionContainer = document.getElementById('map-selection');
            const upgradeList = document.getElementById('upgrade-list');
            const totalCoinsStart = document.getElementById('total-coins-start');
            const totalCoinsUpgrade = document.getElementById('total-coins-upgrade');
            const skyGradient = document.getElementById('sky-gradient');
            const stuntTextElement = document.getElementById('stunt-text');
            
            // --- Game State & Settings ---
            let engine, render, runner, world, car;
            let groundSegments = [], fuelCans = [], coins = [];
            let score = 0, maxTravel = 0, coinsCollected = 0, fuel = 100, jetpackFuel = 100;
            let isGameOver = false, keys = {}, isGasPressed = false, isBrakePressed = false;
            let selectedCarType = 'rally';
            let selectedBiome = 'hills';
            const TERRAIN_SETTINGS = { segmentWidth: 100, yOffset: window.innerHeight * 0.8, initialSegments: 50, lookahead: 20 };
            let audioContext, engineSound, coinSoundGain, jetpackSoundGain;
            let audioInitialized = false;
            let totalPlayerCoins = 0;
            let currentBiome;
            let previousScreen = 'start';
            
            // --- Stunt System State ---
            let airTime = 0, totalRotation = 0, lastAngle = 0, justLanded = false, landingVelocity = 0;
            let flameParticles = [];

            // --- Biome Definitions ---
            const BIOMES = {
                hills: {
                    id: 'hills',
                    name: 'Green Hills',
                    gravity: 1,
                    roughness: 0.55, // Tweaked for more jumps
                    skyColors: { dayTop: {r: 135, g: 206, b: 235}, dayBot: {r: 70, g: 130, b: 180}, nightTop: {r: 10, g: 20, b: 40}, nightBot: {r: 40, g: 50, b: 80} },
                    terrainColors: { top: '#4CAF50', mid: '#5D4037', bot: '#3E2723' },
                    backgrounds: ['mountains', 'clouds-far'],
                    preview: 'linear-gradient(to bottom, #87CEEB, #4682B4)'
                },
                desert: {
                    id: 'desert',
                    name: 'Desert Dunes',
                    gravity: 1,
                    roughness: 0.45, // Tweaked
                    skyColors: { dayTop: {r: 252, g: 217, b: 132}, dayBot: {r: 247, g: 172, b: 94}, nightTop: {r: 30, g: 30, b: 50}, nightBot: {r: 60, g: 50, b: 70} },
                    terrainColors: { top: '#D2B48C', mid: '#C19A6B', bot: '#8B7355' },
                    backgrounds: ['desert-bg', 'clouds-far'],
                    preview: 'linear-gradient(to bottom, #FCD984, #F7AC5E)'
                },
                moon: {
                    id: 'moon',
                    name: 'The Moon',
                    gravity: 0.4,
                    roughness: 0.7, // Tweaked
                    skyColors: { dayTop: {r: 10, g: 10, b: 20}, dayBot: {r: 0, g: 0, b: 0}, nightTop: {r: 10, g: 10, b: 20}, nightBot: {r: 0, g: 0, b: 0} },
                    terrainColors: { top: '#8e7cc3', mid: '#544488', bot: '#3b2f63' },
                    backgrounds: ['moon-bg', 'stars-far'],
                    preview: 'linear-gradient(to bottom, #0a0a14, #000)'
                }
            };

            // --- Car & Upgrade Definitions ---
            const CAR_DEFINITIONS = {
                rally: {
                    name: "Rally Car",
                    description: "A balanced classic.",
                    jetpackOffset: -75,
                    menu_sprite: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-20 -20 180 100'><g id='carBody'><defs><linearGradient id='gradRally' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%23e74c3c'/><stop offset='100%' stop-color='%23c0392b'/></linearGradient><linearGradient id='winRally' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%2381ecec'/><stop offset='100%' stop-color='%2374b9ff'/></linearGradient></defs><path d='M10 25 L25 10 H110 L135 30 H125 L110 40 H20 L10 25 Z' fill='url(%23gradRally)'/><path d='M28 11 H70 L60 2 H40 Z' fill='url(%23winRally)'/></g><circle cx='35' cy='45' r='18' fill='%232c3e50' stroke='%23bdc3c7' stroke-width='2' /><circle cx='105' cy='45' r='18' fill='%232c3e50' stroke='%23bdc3c7' stroke-width='2' /></svg>",
                    body_sprite: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 140 50'><defs><linearGradient id='gradRallyB' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%23e74c3c'/><stop offset='100%' stop-color='%23c0392b'/></linearGradient><linearGradient id='winRallyB' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%2381ecec'/><stop offset='100%' stop-color='%2374b9ff'/></linearGradient></defs><path d='M10 25 L25 10 H110 L135 30 H125 L110 40 H20 L10 25 Z' fill='url(%23gradRallyB)'/><path d='M28 11 H70 L60 2 H40 Z' fill='url(%23winRallyB)'/></svg>",
                    create: createRallyCar,
                    upgrades: { engine: { label: "Engine", level: 0, costs: [10, 25, 50, 100], values: [0.1, 0.12, 0.14, 0.16, 0.18] }, fuel: { label: "Fuel Tank", level: 0, costs: [5, 15, 30, 60], values: [100, 120, 140, 160, 180] }, tires: { label: "Tires", level: 0, costs: [8, 20, 40, 80], values: [0.8, 0.85, 0.9, 0.95, 1.0] }, suspension: { label: "Suspension", level: 0, costs: [12, 28, 55, 110], values: [0.2, 0.18, 0.16, 0.14, 0.12] },}
                },
                truck: {
                    name: "Monster Truck",
                    description: "Powerful with massive grip.",
                    jetpackOffset: -80,
                    menu_sprite: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-20 -10 200 120'><g id='carBody'><defs><linearGradient id='gradTruck' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%233498db'/><stop offset='100%' stop-color='%232980b9'/></linearGradient><linearGradient id='winTruck' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%2381ecec'/><stop offset='100%' stop-color='%2374b9ff'/></linearGradient></defs><path d='M0 30 H150 V55 H0 Z' fill='url(%23gradTruck)'/><path d='M20 5 H80 V30 H20 Z' fill='url(%23gradTruck)'/><path d='M23 7 H77 V20 H23 Z' fill='url(%23winTruck)'/></g><circle cx='40' cy='65' r='35' fill='%232c3e50' stroke='%23bdc3c7' stroke-width='3'/><circle cx='110' cy='65' r='35' fill='%232c3e50' stroke='%23bdc3c7' stroke-width='3'/></svg>",
                    body_sprite: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 150 80'><defs><linearGradient id='gradTruckB' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%233498db'/><stop offset='100%' stop-color='%232980b9'/></linearGradient><linearGradient id='winTruckB' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%2381ecec'/><stop offset='100%' stop-color='%2374b9ff'/></linearGradient></defs><path d='M0 30 H150 V55 H0 Z' fill='url(%23gradTruckB)'/><path d='M20 5 H80 V30 H20 Z' fill='url(%23gradTruckB)'/><path d='M23 7 H77 V20 H23 Z' fill='url(%23winTruckB)'/></svg>",
                    create: createMonsterTruck,
                     upgrades: { engine: { label: "Engine", level: 0, costs: [15, 30, 60, 120], values: [0.18, 0.21, 0.24, 0.27, 0.3] }, fuel: { label: "Fuel Tank", level: 0, costs: [5, 15, 30, 60], values: [100, 120, 140, 160, 180] }, tires: { label: "Tires", level: 0, costs: [10, 25, 50, 100], values: [0.9, 0.95, 1.0, 1.05, 1.1] }, suspension: { label: "Suspension", level: 0, costs: [10, 22, 45, 90], values: [0.1, 0.09, 0.08, 0.07, 0.06] },}
                },
                sports: {
                    name: "Sports Car",
                    description: "Extremely fast and unstable.",
                    jetpackOffset: -85,
                    menu_sprite: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-10 -15 180 90'><g id='carBody'><defs><linearGradient id='gradSports' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%23f1c40f'/><stop offset='100%' stop-color='%23f39c12'/></linearGradient><linearGradient id='winSports' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%2355efc4'/><stop offset='100%' stop-color='%2300b894'/></linearGradient></defs><path d='M5 25 L30 8 H130 L155 25 L145 35 H15 Z' fill='url(%23gradSports)'/><path d='M40 9 H90 L100 2 H50 Z' fill='url(%23winSports)'/></g><circle cx='40' cy='40' r='18' fill='%231e272e' stroke='%23ecf0f1' stroke-width='2' /><circle cx='120' cy='40' r='18' fill='%231e272e' stroke='%23ecf0f1' stroke-width='2' /></svg>",
                    body_sprite: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 45'><defs><linearGradient id='gradSportsB' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%23f1c40f'/><stop offset='100%' stop-color='%23f39c12'/></linearGradient><linearGradient id='winSportsB' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='%2355efc4'/><stop offset='100%' stop-color='%2300b894'/></linearGradient></defs><path d='M5 25 L30 8 H130 L155 25 L145 35 H15 Z' fill='url(%23gradSportsB)'/><path d='M40 9 H90 L100 2 H50 Z' fill='url(%23winSportsB)'/></svg>",
                    create: createSportsCar,
                    upgrades: { engine: { label: "Engine", level: 0, costs: [20, 40, 80, 150], values: [0.07, 0.08, 0.09, 0.1, 0.11] }, fuel: { label: "Fuel Tank", level: 0, costs: [5, 15, 30, 60], values: [100, 115, 130, 145, 160] }, tires: { label: "Tires", level: 0, costs: [5, 15, 30, 60], values: [0.7, 0.72, 0.74, 0.76, 0.78] }, suspension: { label: "Suspension", level: 0, costs: [15, 35, 70, 140], values: [0.4, 0.35, 0.3, 0.25, 0.2] },}
                }
            };
            
            // --- AUDIO HANDLING ---
            function initAudio() {
                if (audioInitialized || audioContext) return;
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // Engine Sound
                    engineSound = audioContext.createOscillator();
                    const engineGain = audioContext.createGain();
                    engineSound.type = 'square';
                    engineSound.frequency.setValueAtTime(40, audioContext.currentTime);
                    engineGain.gain.setValueAtTime(0, audioContext.currentTime);
                    engineSound.connect(engineGain).connect(audioContext.destination);
                    engineSound.start();
                    engineSound.gainNode = engineGain;
                    
                    // Coin Sound
                    coinSoundGain = audioContext.createGain();
                    coinSoundGain.gain.value = 0;
                    coinSoundGain.connect(audioContext.destination);

                    // Jetpack Sound
                    jetpackSoundGain = audioContext.createGain();
                    jetpackSoundGain.gain.setValueAtTime(0, audioContext.currentTime);
                    jetpackSoundGain.connect(audioContext.destination);

                    audioInitialized = true;
                } catch (e) { console.error("Audio could not be initialized:", e); }
            }

            function playCoinSound() { if (!audioInitialized) return; const osc = audioContext.createOscillator(); osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioContext.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1); coinSoundGain.gain.cancelScheduledValues(audioContext.currentTime); coinSoundGain.gain.setValueAtTime(0.3, audioContext.currentTime); coinSoundGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3); osc.connect(coinSoundGain); osc.start(); osc.stop(audioContext.currentTime + 0.3); }
            function playGameOverSound() { if (!audioInitialized) return; const osc = audioContext.createOscillator(); const gain = audioContext.createGain(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(200, audioContext.currentTime); osc.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 1); gain.gain.setValueAtTime(0.4, audioContext.currentTime); gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1); osc.connect(gain).connect(audioContext.destination); osc.start(); osc.stop(audioContext.currentTime + 1); }
            function setJetpackSound(active) { if (!audioInitialized) return; if(active){ const osc = audioContext.createOscillator(); const noise = audioContext.createBufferSource(); const buffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.5, audioContext.sampleRate); const data = buffer.getChannelData(0); for (let i = 0; i < data.length; i++) { data[i] = Math.random() * 2 - 1; } noise.buffer = buffer; noise.loop = true; osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, audioContext.currentTime); osc.frequency.linearRampToValueAtTime(300, audioContext.currentTime + 0.5); osc.connect(jetpackSoundGain); noise.connect(jetpackSoundGain); osc.start(); noise.start(); jetpackSoundGain.gain.setTargetAtTime(0.15, audioContext.currentTime, 0.1); setJetpackSound.sources = [osc, noise]; } else { if (setJetpackSound.sources) { setJetpackSound.sources.forEach(s => s.stop(audioContext.currentTime + 0.2)); } jetpackSoundGain.gain.setTargetAtTime(0, audioContext.currentTime, 0.2); } }
            
            // --- GAME INITIALIZATION & SETUP ---
            function setupUI() {
                carSelectionContainer.innerHTML = '';
                for (const type in CAR_DEFINITIONS) {
                    const carDef = CAR_DEFINITIONS[type];
                    const option = document.createElement('div');
                    option.className = 'selection-option';
                    option.dataset.car = type;
                    if (type === selectedCarType) option.classList.add('selected');
                    option.innerHTML = `<h3>${carDef.name}</h3><img src="${carDef.menu_sprite.replace(/"/g, "'")}" class="car-preview" alt="${carDef.name}"/><p>${carDef.description}</p>`;
                    carSelectionContainer.appendChild(option);
                }
                mapSelectionContainer.innerHTML = '';
                for (const key in BIOMES) {
                    const biome = BIOMES[key];
                    const option = document.createElement('div');
                    option.className = 'selection-option';
                    option.dataset.biome = key;
                    if (key === selectedBiome) option.classList.add('selected');
                    option.innerHTML = `<h3>${biome.name}</h3><div class="map-preview" style="background: ${biome.preview}"></div>`;
                    mapSelectionContainer.appendChild(option);
                }
                updateTotalCoinsDisplay();
            }

            function init() {
                currentBiome = BIOMES[selectedBiome];
                document.querySelectorAll('.parallax-bg').forEach(bg => bg.style.opacity = 0);
                currentBiome.backgrounds.forEach(bgId => document.getElementById(bgId).style.opacity = 1);
                const carDef = CAR_DEFINITIONS[selectedCarType];
                fuel = carDef.upgrades.fuel.values[carDef.upgrades.fuel.level];
                jetpackFuel = 100;
                score = 0; maxTravel = 0; coinsCollected = 0;
                airTime = 0; totalRotation = 0;
                isGameOver = false; groundSegments = []; fuelCans = []; coins = [];
                keys = {}; isGasPressed = false; isBrakePressed = false;
                startScreen.classList.remove('active');
                gameOverScreen.classList.remove('active');
                uiOverlay.style.display = 'flex';
                engine = Engine.create();
                world = engine.world;
                world.gravity.y = currentBiome.gravity;
                render = Render.create({ element: gameContainer, engine: engine, options: { width: window.innerWidth, height: window.innerHeight, wireframes: false, background: 'transparent' } });
                car = carDef.create(200, window.innerHeight / 2 - 200);
                lastAngle = car.chassis.angle;
                generateInitialTerrain();
                World.add(world, [car.composite]);
                runner = Runner.create();
                Runner.run(runner, engine);
                Render.run(render);
                setupGameEventListeners();
                Events.on(engine, 'beforeUpdate', gameLoop);
                Events.on(render, 'afterRender', renderEffects);
            }
            
            // --- CAR CREATION ---
            function createRallyCar(x, y) {
                const group = Body.nextGroup(true);
                const upgrades = CAR_DEFINITIONS.rally.upgrades;
                const wheelFriction = upgrades.tires.values[upgrades.tires.level];
                const wheelRadius = 18;
                const chassis = Bodies.rectangle(x, y, 140, 20, { label: 'chassis', collisionFilter: { group }, chamfer: { radius: 10 }, density: 0.001, render: { sprite: { texture: CAR_DEFINITIONS.rally.body_sprite, xScale: 1, yScale: 1.25 } } });
                const driverHead = Bodies.circle(x - 20, y - 10, 15, { collisionFilter: { group }, density: 0.0001, render: { visible: false } });
                const wheelRender = { sprite: { texture: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 50'><circle cx='25' cy='25' r='25' fill='%232c3e50'/><circle cx='25' cy='25' r='15' fill='none' stroke='%23bdc3c7' stroke-width='3'/><circle cx='25' cy='25' r='10' fill='%2334495e'/></svg>", xScale: wheelRadius/25, yScale: wheelRadius/25 }};
                const wheelA = Bodies.circle(x - 55, y + 20, wheelRadius, { collisionFilter: { group }, friction: wheelFriction, density: 0.01, render: wheelRender });
                const wheelB = Bodies.circle(x + 55, y + 20, wheelRadius, { collisionFilter: { group }, friction: wheelFriction, density: 0.01, render: wheelRender });
                const carComposite = Composite.create({ label: 'Car' });
                Composite.add(carComposite, [chassis, wheelA, wheelB, driverHead]);
                Composite.add(carComposite, Constraint.create({ bodyA: chassis, bodyB: driverHead, stiffness: 1, length: 0, render: { visible: false } }));
                const axleA = Constraint.create({ bodyA: chassis, bodyB: wheelA, pointA: { x: -55, y: 15 }, stiffness: upgrades.suspension.values[upgrades.suspension.level], damping: 0.1, render: { visible: false } });
                const axleB = Constraint.create({ bodyA: chassis, bodyB: wheelB, pointA: { x: 55, y: 15 }, stiffness: upgrades.suspension.values[upgrades.suspension.level], damping: 0.1, render: { visible: false } });
                Composite.add(carComposite, [axleA, axleB]);
                return { composite: carComposite, chassis, wheelA, wheelB, driverHead };
            }

            function createMonsterTruck(x, y) {
                const group = Body.nextGroup(true);
                const upgrades = CAR_DEFINITIONS.truck.upgrades;
                const wheelFriction = upgrades.tires.values[upgrades.tires.level];
                const wheelRadius = 35;
                const chassis = Bodies.rectangle(x, y, 150, 40, { label: 'chassis', collisionFilter: { group }, density: 0.002, render: { sprite: { texture: CAR_DEFINITIONS.truck.body_sprite, xScale: 1, yScale: 1 } } });
                const driverHead = Bodies.circle(x - 20, y - 25, 15, { collisionFilter: { group }, density: 0.0001, render: { visible: false } });
                const wheelRender = { sprite: { texture: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80'><circle cx='40' cy='40' r='40' fill='%232c3e50'/><path d='M20 40 L60 40 M40 20 L40 60' stroke='%237f8c8d' stroke-width='8'/><circle cx='40' cy='40' r='20' fill='%2334495e'/></svg>", xScale: wheelRadius/40, yScale: wheelRadius/40 }};
                const wheelA = Bodies.circle(x - 65, y + 35, wheelRadius, { collisionFilter: { group }, friction: wheelFriction, density: 0.02, render: wheelRender });
                const wheelB = Bodies.circle(x + 65, y + 35, wheelRadius, { collisionFilter: { group }, friction: wheelFriction, density: 0.02, render: wheelRender });
                const carComposite = Composite.create({ label: 'Car' });
                Composite.add(carComposite, [chassis, wheelA, wheelB, driverHead]);
                Composite.add(carComposite, Constraint.create({ bodyA: chassis, bodyB: driverHead, stiffness: 1, length: 0, render: { visible: false } }));
                const axleA = Constraint.create({ bodyA: chassis, bodyB: wheelA, pointA: { x: -65, y: 25 }, stiffness: upgrades.suspension.values[upgrades.suspension.level], damping: 0.2, render: { visible: false } });
                const axleB = Constraint.create({ bodyA: chassis, bodyB: wheelB, pointA: { x: 65, y: 25 }, stiffness: upgrades.suspension.values[upgrades.suspension.level], damping: 0.2, render: { visible: false } });
                Composite.add(carComposite, [axleA, axleB]);
                return { composite: carComposite, chassis, wheelA, wheelB, driverHead };
            }

            function createSportsCar(x, y) {
                const group = Body.nextGroup(true);
                const upgrades = CAR_DEFINITIONS.sports.upgrades;
                const wheelFriction = upgrades.tires.values[upgrades.tires.level];
                const wheelRadius = 18;
                const chassis = Bodies.rectangle(x, y, 160, 15, { label: 'chassis', collisionFilter: { group }, density: 0.0008, render: { sprite: { texture: CAR_DEFINITIONS.sports.body_sprite, xScale: 1, yScale: 1.1 } } });
                const driverHead = Bodies.circle(x + 10, y - 10, 12, { collisionFilter: { group }, density: 0.0001, render: { visible: false } });
                const wheelRender = { sprite: { texture: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 50'><circle cx='25' cy='25' r='25' fill='%231e272e'/><g stroke='%23ecf0f1' stroke-width='2'><path d='M25 5 L25 45 M5 25 L45 25'/></g><circle cx='25' cy='25' r='10' fill='%23dcdde1'/></svg>", xScale: wheelRadius/25, yScale: wheelRadius/25 }};
                const wheelA = Bodies.circle(x - 60, y + 18, wheelRadius, { collisionFilter: { group }, friction: wheelFriction, density: 0.008, render: wheelRender });
                const wheelB = Bodies.circle(x + 60, y + 18, wheelRadius, { collisionFilter: { group }, friction: wheelFriction, density: 0.008, render: wheelRender });
                const carComposite = Composite.create({ label: 'Car' });
                Composite.add(carComposite, [chassis, wheelA, wheelB, driverHead]);
                Composite.add(carComposite, Constraint.create({ bodyA: chassis, bodyB: driverHead, stiffness: 1, length: 0, render: { visible: false } }));
                const axleA = Constraint.create({ bodyA: chassis, bodyB: wheelA, pointA: { x: -60, y: 10 }, stiffness: upgrades.suspension.values[upgrades.suspension.level], damping: 0.05, render: { visible: false } });
                const axleB = Constraint.create({ bodyA: chassis, bodyB: wheelB, pointA: { x: 60, y: 10 }, stiffness: upgrades.suspension.values[upgrades.suspension.level], damping: 0.05, render: { visible: false } });
                Composite.add(carComposite, [axleA, axleB]);
                return { composite: carComposite, chassis, wheelA, wheelB, driverHead };
            }

            // --- TERRAIN & BIOME MANAGEMENT ---
            function createTerrainSegment(startX, startY, roughness) {
                // Biased the Y-change to prevent slopes from becoming inverted.
                const yChange = (Math.random() - 0.52) * TERRAIN_SETTINGS.segmentWidth * roughness;
                const endX = startX + TERRAIN_SETTINGS.segmentWidth;
                const endY = startY + yChange;

                const vertices = [ { x: startX, y: startY }, { x: endX, y: endY }, { x: endX, y: window.innerHeight + 200 }, { x: startX, y: window.innerHeight + 200 } ];
                const gradient = render.context.createLinearGradient(startX, startY - 100, startX, startY + 100);
                gradient.addColorStop(0, currentBiome.terrainColors.top);
                gradient.addColorStop(0.5, currentBiome.terrainColors.mid);
                gradient.addColorStop(1, currentBiome.terrainColors.bot);
                const body = Bodies.fromVertices( (startX + endX) / 2, (startY + endY + window.innerHeight * 2 + 400) / 4, [vertices], { isStatic: true, friction: 1.0, render: { fillStyle: gradient, strokeStyle: currentBiome.terrainColors.bot, lineWidth: 8 } });
                return { body, startPoint: { x: startX, y: startY }, endPoint: { x: endX, y: endY } };
            }

            function generateInitialTerrain() {
                let currentX = -TERRAIN_SETTINGS.segmentWidth * 10;
                let currentY = TERRAIN_SETTINGS.yOffset;
                for (let i = 0; i < TERRAIN_SETTINGS.initialSegments; i++) {
                    const rampUp = (i < 15) ? (i / 15) : 1;
                    const currentRoughness = currentBiome.roughness * rampUp;
                    const segment = createTerrainSegment(currentX, currentY, currentRoughness);
                    groundSegments.push(segment);
                    World.add(world, segment.body);
                    if (i > 15 && Math.random() < 0.1) addFuelCan(segment.endPoint.x, segment.endPoint.y - 80);
                    if (i > 15 && Math.random() < 0.2) addCoin(segment.endPoint.x, segment.endPoint.y - 60);
                    currentX = segment.endPoint.x;
                    currentY = segment.endPoint.y;
                }
            }

            function updateTerrain() {
                const carX = car.chassis.position.x;
                // Progressive difficulty
                const difficultyFactor = 1 + (carX / 60000);
                let lastSegment = groundSegments[groundSegments.length - 1];

                while (carX > lastSegment.endPoint.x - TERRAIN_SETTINGS.lookahead * TERRAIN_SETTINGS.segmentWidth) {
                    const newSegment = createTerrainSegment(lastSegment.endPoint.x, lastSegment.endPoint.y, currentBiome.roughness * difficultyFactor);
                    groundSegments.push(newSegment);
                    World.add(world, newSegment.body);
                    if (Math.random() < 0.1) addFuelCan(newSegment.endPoint.x, newSegment.endPoint.y - 80);
                    if (Math.random() < 0.2) addCoin(newSegment.endPoint.x, newSegment.endPoint.y - 60);
                    lastSegment = newSegment; 
                }
                while (carX > groundSegments[0].endPoint.x + TERRAIN_SETTINGS.segmentWidth * 15 && groundSegments.length > TERRAIN_SETTINGS.initialSegments) {
                    World.remove(world, groundSegments.shift().body);
                }
            }
            
            function addFuelCan(x, y) { const can = Bodies.rectangle(x, y, 60, 80, { isStatic: true, isSensor: true, label: 'fuelCan', render: { sprite: { texture: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 50'><defs><linearGradient id='grad' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='%23e55039'/><stop offset='100%' stop-color='%23c0392b'/></linearGradient></defs><path d='M5 5 H35 L40 10 V45 L35 50 H5 L0 45 V10 Z' fill='url(%23grad)'/><path d='M10 0 H20 V5 H10 Z' fill='%2334495e'/><path d='M25 15 H35 V20 H25 Z' fill='rgba(255,255,255,0.3)'/></svg>", xScale: 0.75, yScale: 0.8 } } }); fuelCans.push(can); World.add(world, can); }
            function addCoin(x, y) { const coin = Bodies.circle(x, y, 20, { isStatic: true, isSensor: true, label: 'coin', render: { sprite: { texture: "data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'><defs><radialGradient id='grad' cx='50%' cy='50%' r='50%' fx='50%' fy='50%'><stop offset='0%' stop-color='%23f1c40f' stop-opacity='1' /><stop offset='100%' stop-color='%23f39c12' stop-opacity='1' /></radialGradient></defs><circle cx='20' cy='20' r='20' fill='url(%23grad)'/><circle cx='20' cy='20' r='18' fill='none' stroke='%23e67e22' stroke-width='2'/><text x='50%' y='50%' dy='.3em' text-anchor='middle' font-size='20' font-weight='bold' fill='%23d35400'>$</text></svg>", xScale: 1, yScale: 1 } } }); coins.push(coin); World.add(world, coin); }
            
            function checkCollisions(pair) {
                const carParts = [car.chassis, car.wheelA, car.wheelB];
                const check = (bodyA, bodyB) => {
                    if (bodyA.label === 'chassis' || bodyB.label === 'chassis') {
                        checkGameOver(pair);
                    }
                    const isBodyACollectible = ['fuelCan', 'coin'].includes(bodyA.label);
                    const isBodyBCollectible = ['fuelCan', 'coin'].includes(bodyB.label);
                    const isBodyACar = carParts.includes(bodyA);
                    const isBodyBCar = carParts.includes(bodyB);
                    
                    if (isBodyACar && isBodyBCollectible) {
                        if (bodyB.label === 'fuelCan') collectFuel(bodyB);
                        if (bodyB.label === 'coin') collectCoin(bodyB);
                    } else if (isBodyBCar && isBodyACollectible) {
                        if (bodyA.label === 'fuelCan') collectFuel(bodyA);
                        if (bodyA.label === 'coin') collectCoin(bodyA);
                    }
                };
                check(pair.bodyA, pair.bodyB);
            }

            function collectFuel(can) { if (!fuelCans.includes(can)) return; fuel = Math.min(CAR_DEFINITIONS[selectedCarType].upgrades.fuel.values[CAR_DEFINITIONS[selectedCarType].upgrades.fuel.level], fuel + 30); World.remove(world, can); fuelCans = fuelCans.filter(f => f !== can); playCoinSound(); }
            function collectCoin(coin) { if (!coins.includes(coin)) return; coinsCollected++; World.remove(world, coin); coins = coins.filter(c => c !== coin); playCoinSound(); }

            // --- DYNAMIC SKY ---
            function updateSky() {
                if (!currentBiome || !engine || !engine.timing) {
                    const biomeToDisplay = BIOMES[selectedBiome];
                    if (biomeToDisplay) {
                        const { dayTop, dayBot } = biomeToDisplay.skyColors;
                        skyGradient.style.background = `linear-gradient(to bottom, rgb(${dayTop.r}, ${dayTop.g}, ${dayTop.b}), rgb(${dayBot.r}, ${dayBot.g}, ${dayBot.b}))`;
                    }
                    return;
                }

                const cycleSpeed = 0.00005;
                const time = engine.timing.timestamp * cycleSpeed;
                const sinTime = Math.sin(time);
                const { dayTop, dayBot, nightTop, nightBot } = currentBiome.skyColors;
                const sunsetTop = {r: 255, g: 165, b: 0}, sunsetBot = {r: 255, g: 69, b: 0};
                let t = (sinTime + 1) / 2;
                let rT, gT, bT, rB, gB, bB;

                if ((t > 0.95 || t < 0.05) && currentBiome.id !== 'moon') {
                    let sunsetT = t > 0.5 ? 1 - ((t - 0.95) / 0.05) : t / 0.05;
                    rT = dayTop.r * (1-sunsetT) + sunsetTop.r * sunsetT; gT = dayTop.g * (1-sunsetT) + sunsetTop.g * sunsetT; bT = dayTop.b * (1-sunsetT) + sunsetTop.b * sunsetT;
                    rB = dayBot.r * (1-sunsetT) + sunsetBot.r * sunsetT; gB = dayBot.g * (1-sunsetT) + sunsetBot.g * sunsetT; bB = dayBot.b * (1-sunsetT) + sunsetBot.b * sunsetT;
                } else {
                    rT = dayTop.r * t + nightTop.r * (1 - t); gT = dayTop.g * t + nightTop.g * (1 - t); bT = dayTop.b * t + nightTop.b * (1 - t);
                    rB = dayBot.r * t + nightBot.r * (1 - t); gB = dayBot.g * t + nightBot.g * (1 - t); bB = dayBot.b * t + nightBot.b * (1 - t);
                }
                skyGradient.style.background = `linear-gradient(to bottom, rgb(${rT}, ${gT}, ${bT}), rgb(${rB}, ${gB}, ${bB}))`;
            }

            // --- UPGRADE SYSTEM ---
            function showUpgradeScreen() {
                const carDef = CAR_DEFINITIONS[selectedCarType];
                upgradeList.innerHTML = '';
                for (const key in carDef.upgrades) {
                    const upgrade = carDef.upgrades[key];
                    const item = document.createElement('div');
                    item.className = 'upgrade-item';
                    const maxLevel = upgrade.values.length - 1;
                    const isMaxed = upgrade.level >= maxLevel;
                    const cost = isMaxed ? 'MAX' : `${upgrade.costs[upgrade.level]} ðŸ’°`;
                    const canAfford = totalPlayerCoins >= (isMaxed ? Infinity : upgrade.costs[upgrade.level]);
                    item.innerHTML = `<h3>${upgrade.label}</h3><p>Level ${upgrade.level + 1} / ${maxLevel + 1}</p><div class="level-bar"><div class="level-bar-inner" style="width: ${((upgrade.level + 1) / (maxLevel + 1)) * 100}%"></div></div><button class="upgrade-button ${isMaxed || !canAfford ? 'maxed' : ''}" data-upgrade="${key}" ${isMaxed || !canAfford ? 'disabled' : ''}>${isMaxed ? 'Max Level' : 'Upgrade: ' + cost}</button>`;
                    upgradeList.appendChild(item);
                }
                updateTotalCoinsDisplay();
                startScreen.classList.remove('active');
                gameOverScreen.classList.remove('active');
                upgradeScreen.classList.add('active');
            }

            function purchaseUpgrade(e) {
                if (!e.target.matches('.upgrade-button')) return;
                const key = e.target.dataset.upgrade;
                const carDef = CAR_DEFINITIONS[selectedCarType];
                const upgrade = carDef.upgrades[key];
                const cost = upgrade.costs[upgrade.level];
                if (totalPlayerCoins >= cost && upgrade.level < upgrade.costs.length) {
                    totalPlayerCoins -= cost;
                    upgrade.level++;
                    showUpgradeScreen();
                }
            }
            
            function updateTotalCoinsDisplay() {
                totalCoinsStart.textContent = totalPlayerCoins;
                totalCoinsUpgrade.textContent = totalPlayerCoins;
            }

            // --- GAME LOOP & LOGIC ---
            function gameLoop() {
                if (isGameOver || !car) return;

                const carDef = CAR_DEFINITIONS[selectedCarType];
                const upgrades = carDef.upgrades;
                let engineTorque = upgrades.engine.values[upgrades.engine.level];

                const isAccelerating = keys['ArrowRight'] || keys['d'] || isGasPressed;
                const isBraking = keys['ArrowLeft'] || keys['a'] || isBrakePressed;
                const usingJetpack = (keys[' '] || keys['Space']) && jetpackFuel > 0;
                
                const wasOnGround = airTime === 0;
                const onGround = Query.collides(car.wheelA, groundSegments.map(s => s.body)).length > 0 || Query.collides(car.wheelB, groundSegments.map(s => s.body)).length > 0;
                justLanded = !wasOnGround && onGround;
                
                if (justLanded) landingVelocity = car.chassis.velocity.y;
                
                if (usingJetpack) {
                    // FIX: Jetpack force is now correctly balanced and provides horizontal thrust.
                    const angle = car.chassis.angle;
                    const verticalForce = -0.045 * car.chassis.mass * world.gravity.y; // Balanced lift
                    const horizontalForce = 0.00001 * car.chassis.mass; // Forward push
                    
                    const force = {
                        x: Math.cos(angle) * horizontalForce - Math.sin(angle) * verticalForce,
                        y: Math.sin(angle) * horizontalForce + Math.cos(angle) * verticalForce
                    };

                    Body.applyForce(car.chassis, car.chassis.position, force);
                    jetpackFuel = Math.max(0, jetpackFuel - 0.5);
                } else {
                    jetpackFuel = Math.min(100, jetpackFuel + 0.1);
                }
                setJetpackSound(usingJetpack);

                if (onGround) {
                    processStunts();
                    if (isAccelerating) { Body.setAngularVelocity(car.wheelA, car.wheelA.angularVelocity + engineTorque); Body.setAngularVelocity(car.wheelB, car.wheelB.angularVelocity + engineTorque); fuel -= 0.03; }
                    if (isBraking) { Body.setAngularVelocity(car.wheelA, car.wheelA.angularVelocity - engineTorque * 0.5); Body.setAngularVelocity(car.wheelB, car.wheelB.angularVelocity - engineTorque * 0.5); }
                } else {
                    airTime += engine.timing.deltaTime;
                    const deltaAngle = car.chassis.angle - lastAngle;
                    totalRotation += deltaAngle;
                    
                    let targetAngle = car.chassis.angle % (Math.PI * 2);
                    if (targetAngle > Math.PI) targetAngle -= Math.PI * 2;
                    if (targetAngle < -Math.PI) targetAngle += Math.PI * 2;
                    car.chassis.torque = -targetAngle * 0.2;

                    if (isAccelerating) car.chassis.torque += 0.05;
                    if (isBraking) car.chassis.torque -= 0.05;
                }
                
                lastAngle = car.chassis.angle;

                if(audioInitialized) { const targetGain = (isAccelerating && onGround) ? 0.35 : 0; const targetFreq = (isAccelerating && onGround) ? (40 + Math.min(60, 30 * (Math.abs(car.chassis.velocity.x) / 20))) : 40; engineSound.gainNode.gain.setTargetAtTime(targetGain, audioContext.currentTime, 0.1); engineSound.frequency.setTargetAtTime(targetFreq, audioContext.currentTime, 0.1); }

                fuel -= 0.005;
                maxTravel = Math.max(maxTravel, car.chassis.position.x);
                score = Math.max(0, Math.floor(maxTravel / 100) - 1);
                scoreElement.textContent = `Score: ${score}`;
                coinElement.textContent = coinsCollected;
                fuelBarElement.style.width = `${Math.max(0, (fuel / upgrades.fuel.values[upgrades.fuel.level]) * 100)}%`;
                jetpackBarElement.style.width = `${jetpackFuel}%`;

                Render.lookAt(render, car.chassis, { x: 400, y: 300 });
                const cameraX = car.chassis.position.x - window.innerWidth / 4;
                document.querySelectorAll('.parallax-bg').forEach(bg => {
                    let speed = 0.1;
                    if (bg.id.includes('near')) speed = 0.3;
                    if (bg.id.includes('fg')) speed = 0.6;
                    bg.style.transform = `translateX(${-cameraX * speed}px)`;
                });
                
                updateTerrain();
                updateSky();
                checkGameOver();
            }
            
            // --- Effects, Stunts, and Game Over ---
            function renderEffects() {
                if (isGameOver || !car) return;
                // Render jetpack flame
                if ((keys[' '] || keys['Space']) && jetpackFuel > 0) {
                    const ctx = render.context;
                    const chassis = car.chassis;
                    // FIX: Correctly calculate flame position from the chassis center and rotation
                    const localBackOffset = Vector.create(CAR_DEFINITIONS[selectedCarType].jetpackOffset, 5); // Use the defined offset
                    const rotatedOffset = Vector.rotate(localBackOffset, chassis.angle);
                    const flamePos = Vector.add(chassis.position, rotatedOffset);
                    
                    for (let i = 0; i < 5; i++) {
                        // FIX: Flame velocity should be relative to the car's angle
                        const flameVel = Vector.rotate({ x: -Math.random() * 8 - 5, y: (Math.random() - 0.5) * 5 }, chassis.angle);
                        flameParticles.push({
                            pos: Vector.clone(flamePos),
                            vel: flameVel,
                            radius: Math.random() * 10 + 5,
                            life: 20
                        });
                    }
                }
                
                // Update and draw particles
                const ctx = render.context;
                for (let i = flameParticles.length - 1; i >= 0; i--) {
                    const p = flameParticles[i];
                    p.pos.x += p.vel.x;
                    p.pos.y += p.vel.y;
                    p.life -= 1;
                    p.radius *= 0.95;
                    
                    if (p.life <= 0) {
                        flameParticles.splice(i, 1);
                        continue;
                    }
                    
                    ctx.beginPath();
                    const alpha = p.life / 20;
                    const grad = ctx.createRadialGradient(p.pos.x, p.pos.y, 0, p.pos.x, p.pos.y, p.radius);
                    grad.addColorStop(0, `rgba(255, 200, 50, ${alpha})`);
                    grad.addColorStop(0.8, `rgba(255, 100, 0, ${alpha * 0.5})`);
                    grad.addColorStop(1, `rgba(200, 0, 0, 0)`);
                    ctx.fillStyle = grad;
                    ctx.arc(p.pos.x, p.pos.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            function processStunts() {
                if (justLanded) {
                    if (landingVelocity > 10) {
                        triggerScreenShake(landingVelocity);
                    }
                    const flips = Math.floor(Math.abs(totalRotation) / (Math.PI * 1.9));
                    if (flips > 0) {
                        const bonus = flips * 5;
                        coinsCollected += bonus;
                        showStuntText(`FLIP! +${bonus}ðŸ’°`);
                    } else if (airTime > 500) { // Lowered threshold
                        const bonus = Math.floor(airTime / 500);
                        if (bonus > 0) {
                           coinsCollected += bonus;
                           showStuntText(`AIR TIME! +${bonus}ðŸ’°`);
                        }
                    }
                }
                airTime = 0;
                totalRotation = 0;
            }

            function triggerScreenShake(intensity) {
                const shakeAmount = Math.min(15, intensity * 0.5);
                gameWrapper.style.transform = `translate(${Math.random() * shakeAmount - shakeAmount / 2}px, ${Math.random() * shakeAmount - shakeAmount / 2}px)`;
                setTimeout(() => {
                    gameWrapper.style.transform = 'translate(0,0)';
                }, 100);
            }

            function showStuntText(text) {
                stuntTextElement.textContent = text;
                stuntTextElement.classList.add('show');
                setTimeout(() => {
                    stuntTextElement.classList.remove('show');
                }, 1000);
            }
            
            function checkGameOver(pair = null) {
                 if (isGameOver) return;
                 if (fuel <= 0) {
                    gameOver();
                    return;
                }
                
                const isFlipped = Math.abs(car.chassis.angle) > Math.PI / 2 + 0.2;
                if (isFlipped && pair) {
                    const isChassisCollision = pair.bodyA.label === 'chassis' || pair.bodyB.label === 'chassis';
                    const isGroundCollision = !pair.bodyA.isSensor && !pair.bodyB.isSensor;
                    if (isChassisCollision && isGroundCollision) {
                         gameOver();
                    }
                }
            }

            function gameOver() {
                if (isGameOver) return;
                isGameOver = true;
                totalPlayerCoins += coinsCollected;
                if(audioInitialized) { engineSound.gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.01); setJetpackSound(false); playGameOverSound(); }
                Runner.stop(runner);
                finalScoreElement.textContent = `Final Score: ${score}`;
                finalCoinsElement.textContent = `Coins Collected: ${coinsCollected}`;
                gameOverScreen.classList.add('active');
            }

            function restartGame() {
                if (engine) {
                    World.clear(engine.world);
                    Engine.clear(engine);
                    Events.off(render, 'afterRender', renderEffects);
                    Render.stop(render);
                    Runner.stop(runner);
                    if (render.canvas) render.canvas.remove();
                    render.textures = {};
                }
                uiOverlay.style.display = 'none';
                gameOverScreen.classList.remove('active');
                setupUI();
                startScreen.classList.add('active');
            }
            
            // --- EVENT LISTENERS ---
            function setupGameEventListeners() {
                window.addEventListener('keydown', (e) => { keys[e.code] = true; keys[e.key] = true; });
                window.addEventListener('keyup', (e) => { keys[e.code] = false; keys[e.key] = false; });
                const setupButton = (button, setPressed) => { const press = (e) => { e.preventDefault(); setPressed(true); }; const release = (e) => { e.preventDefault(); setPressed(false); }; button.addEventListener('touchstart', press, { passive: false }); button.addEventListener('touchend', release); button.addEventListener('mousedown', press); button.addEventListener('mouseup', release); button.addEventListener('mouseleave', release); };
                setupButton(gasButton, (pressed) => isGasPressed = pressed);
                setupButton(brakeButton, (pressed) => isBrakePressed = pressed);
                Events.on(engine, 'collisionStart', (event) => { if (!isGameOver) event.pairs.forEach(pair => checkCollisions(pair)); });
            }

            carSelectionContainer.addEventListener('click', (e) => { const carOption = e.target.closest('.selection-option'); if (!carOption) return; document.querySelectorAll('#car-selection .selection-option').forEach(opt => opt.classList.remove('selected')); carOption.classList.add('selected'); selectedCarType = carOption.dataset.car; });
            mapSelectionContainer.addEventListener('click', (e) => { const mapOption = e.target.closest('.selection-option'); if (!mapOption) return; document.querySelectorAll('#map-selection .selection-option').forEach(opt => opt.classList.remove('selected')); mapOption.classList.add('selected'); selectedBiome = mapOption.dataset.biome; });
            startButton.addEventListener('click', () => { initAudio(); init(); });
            restartButton.addEventListener('click', restartGame);
            
            // Handle Upgrade screen navigation
            const openUpgrades = () => { upgradeScreen.classList.add('active'); showUpgradeScreen(); };
            const closeUpgrades = () => { upgradeScreen.classList.remove('active'); if (previousScreen === 'start') { startScreen.classList.add('active'); } else { gameOverScreen.classList.add('active'); } };
            
            upgradesButton.addEventListener('click', () => { previousScreen = 'gameOver'; openUpgrades(); });
            mainUpgradesButton.addEventListener('click', () => { previousScreen = 'start'; openUpgrades(); });
            upgradeCloseButton.addEventListener('click', closeUpgrades);
            upgradeList.addEventListener('click', purchaseUpgrade);

            window.addEventListener('resize', restartGame);
            
            // Initial Setup
            setupUI();
            updateSky();
        })();
    </script>
</body>
</html>
